#!/bin/bash

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DNS Manager v2.0 - DNS Configuration Tool
# Supports Iranian DNS (Shekan, Arvan) and Major International DNS Services
# Methods: NetPlan | systemd-resolved (resolv.conf)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

VERSION="2.0.0"

# Configuration paths
NETPLAN_FILE="/etc/netplan/99-dns-manager.yaml"
SYSTEMD_CONF="/etc/systemd/resolved.conf"
BACKUP_CONF="/etc/systemd/resolved.conf.backup"
RESOLV_CONF="/etc/resolv.conf"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
WHITE='\033[1;37m'
DIM='\033[2m'
NC='\033[0m'
BOLD='\033[1m'

# Check for root privileges
if [ "$EUID" -ne 0 ]; then
  echo -e "${RED}âœ— This script must be run as root (sudo).${NC}"
  exit 1
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Utility Functions
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

print_msg() {
  local color=$1
  local message=$2
  echo -e "${color}${message}${NC}"
}

print_line() {
  echo -e "${BLUE}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# System Detection Functions
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

check_netplan_installed() {
  command -v netplan &> /dev/null
}

check_systemd_resolved() {
  systemctl is-active --quiet systemd-resolved
}

get_active_interface() {
  ip route | grep '^default' | awk '{print $5}' | head -n1
}

get_interface_type() {
  local iface=$1
  if [[ $iface == wl* ]]; then
    echo "wifis"
  else
    echo "ethernets"
  fi
}

validate_ipv4() {
  local ip=$1
  # Check format
  if ! [[ $ip =~ ^([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$ ]]; then
    return 1
  fi
  # Check each octet range (0-255)
  local i
  for i in 1 2 3 4; do
    local octet="${BASH_REMATCH[$i]}"
    if (( octet > 255 )); then
      return 1
    fi
  done
  return 0
}

# Try to identify DNS provider name from known IPs
identify_dns_provider() {
  local ip=$1
  case "$ip" in
    178.22.122.101|185.51.200.1)   echo "Shekan Pro" ;;
    178.22.122.100|185.51.200.2)   echo "Shekan Free" ;;
    217.218.127.127|217.218.155.155) echo "Arvan Cloud" ;;
    8.8.8.8|8.8.4.4)              echo "Google DNS" ;;
    1.1.1.1|1.0.0.1)              echo "Cloudflare" ;;
    9.9.9.9|149.112.112.112)      echo "Quad9" ;;
    208.67.222.222|208.67.220.220) echo "OpenDNS" ;;
    94.140.14.14|94.140.15.15)    echo "AdGuard" ;;
    4.2.2.4|4.2.2.1)              echo "Level3" ;;
    127.0.0.53)                    echo "systemd-stub" ;;
    *)                             echo "" ;;
  esac
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Display Functions
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

show_header() {
  clear
  echo ""
  echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
  echo -e "${BLUE}â•‘${NC}${BOLD}${WHITE}           ğŸŒ  DNS Manager  v${VERSION}                          ${NC}${BLUE}â•‘${NC}"
  echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
}

show_current_dns_status() {
  local interface=$(get_active_interface)

  echo ""
  echo -e "${CYAN}â”Œâ”€â”€ Current DNS Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
  echo -e "${CYAN}â”‚${NC} ${WHITE}Interface:${NC} ${GREEN}${interface:-N/A}${NC}"
  echo -e "${CYAN}â”‚${NC}"

  # â”€â”€ NetPlan Config â”€â”€
  if [ -f "$NETPLAN_FILE" ]; then
    local np_dns=$(grep -A5 'addresses:' "$NETPLAN_FILE" 2>/dev/null | head -1 | sed 's/.*\[//;s/\].*//;s/"//g')
    local np_provider=""
    local first_ip=$(echo "$np_dns" | cut -d',' -f1 | xargs)
    if [ -n "$first_ip" ]; then
      np_provider=$(identify_dns_provider "$first_ip")
    fi
    echo -e "${CYAN}â”‚${NC} ${YELLOW}NetPlan${NC} (${DIM}${NETPLAN_FILE}${NC}):"
    if [ -n "$np_provider" ]; then
      echo -e "${CYAN}â”‚${NC}   DNS: ${GREEN}${np_dns}${NC}  ${DIM}(${np_provider})${NC}"
    else
      echo -e "${CYAN}â”‚${NC}   DNS: ${GREEN}${np_dns}${NC}"
    fi
  else
    echo -e "${CYAN}â”‚${NC} ${YELLOW}NetPlan${NC}: ${DIM}No DNS Manager config found${NC}"
  fi

  echo -e "${CYAN}â”‚${NC}"

  # â”€â”€ resolv.conf â”€â”€
  echo -e "${CYAN}â”‚${NC} ${YELLOW}resolv.conf${NC} (${DIM}${RESOLV_CONF}${NC}):"
  local resolv_ns=$(grep "^nameserver" "$RESOLV_CONF" 2>/dev/null)
  if [ -n "$resolv_ns" ]; then
    while IFS= read -r line; do
      local ns_ip=$(echo "$line" | awk '{print $2}')
      local ns_name=$(identify_dns_provider "$ns_ip")
      if [ -n "$ns_name" ]; then
        echo -e "${CYAN}â”‚${NC}   ${GREEN}${line}${NC}  ${DIM}(${ns_name})${NC}"
      else
        echo -e "${CYAN}â”‚${NC}   ${GREEN}${line}${NC}"
      fi
    done <<< "$resolv_ns"
  else
    echo -e "${CYAN}â”‚${NC}   ${DIM}No nameservers found${NC}"
  fi

  echo -e "${CYAN}â”‚${NC}"

  # â”€â”€ Resolvectl â”€â”€
  if command -v resolvectl &> /dev/null; then
    echo -e "${CYAN}â”‚${NC} ${YELLOW}Resolvectl Status${NC}:"
    local dns_servers=$(resolvectl status 2>/dev/null | grep -A 10 "DNS Servers" | grep -E "^\s+[0-9]" | head -4)
    if [ -n "$dns_servers" ]; then
      while IFS= read -r line; do
        local srv_ip=$(echo "$line" | xargs)
        local srv_name=$(identify_dns_provider "$srv_ip")
        if [ -n "$srv_name" ]; then
          echo -e "${CYAN}â”‚${NC}   ${GREEN}${srv_ip}${NC}  ${DIM}(${srv_name})${NC}"
        else
          echo -e "${CYAN}â”‚${NC}   ${GREEN}${srv_ip}${NC}"
        fi
      done <<< "$dns_servers"
    else
      echo -e "${CYAN}â”‚${NC}   ${DIM}No DNS servers reported${NC}"
    fi
  fi

  # â”€â”€ systemd-resolved status â”€â”€
  echo -e "${CYAN}â”‚${NC}"
  if check_systemd_resolved; then
    echo -e "${CYAN}â”‚${NC} ${WHITE}systemd-resolved:${NC} ${GREEN}â— Active${NC}"
  else
    echo -e "${CYAN}â”‚${NC} ${WHITE}systemd-resolved:${NC} ${RED}â— Inactive${NC}"
  fi

  echo -e "${CYAN}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
}

show_menu() {
  show_header
  show_current_dns_status

  echo ""
  echo -e " ${GREEN}â”€â”€ Iranian DNS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}    ${YELLOW}â”€â”€ International DNS â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
  echo -e "  ${WHITE}1)${NC} Shekan Pro                ${WHITE}5)${NC} Cloudflare"
  echo -e "  ${WHITE}2)${NC} Shekan Free               ${WHITE}6)${NC} Quad9 ${DIM}(Malware Block)${NC}"
  echo -e "  ${WHITE}3)${NC} Arvan Cloud               ${WHITE}7)${NC} OpenDNS"
  echo -e "  ${WHITE}4)${NC} Google DNS                ${WHITE}8)${NC} AdGuard ${DIM}(Ad Block)${NC}"
  echo -e "                               ${WHITE}9)${NC} Level3 ${DIM}(4.2.2.4)${NC}"
  echo ""
  echo -e "  ${MAGENTA}C)${NC} ${MAGENTA}Custom DNS${NC} ${DIM}(enter your own)${NC}"

  echo ""
  echo -e " ${CYAN}â”€â”€ System Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
  echo -e "  ${WHITE}S)${NC} System Management ${DIM}(view, edit, disable, delete, rollback)${NC}"
  echo -e "  ${WHITE}0)${NC} Exit"

  echo ""
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Method Selection (Step 2)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

choose_apply_method() {
  # Returns: "netplan" or "resolved"
  echo ""
  print_line
  echo -e " ${BOLD}${WHITE}How do you want to apply DNS?${NC}"
  print_line
  echo ""

  local netplan_available=false
  if check_netplan_installed; then
    netplan_available=true
    echo -e "  ${WHITE}1)${NC} ${GREEN}NetPlan${NC}          ${DIM}(/etc/netplan/99-dns-manager.yaml)${NC}"
  else
    echo -e "  ${DIM}1) NetPlan          (not installed)${NC}"
  fi

  echo -e "  ${WHITE}2)${NC} ${GREEN}resolv.conf${NC}      ${DIM}(systemd-resolved /etc/systemd/resolved.conf)${NC}"
  echo ""

  while true; do
    echo -n -e "  ${WHITE}Choose method [1/2]: ${NC}"
    read -r method_choice

    case "$method_choice" in
      1)
        if [ "$netplan_available" = true ]; then
          echo "netplan"
          return
        else
          print_msg "$YELLOW" "  âš  NetPlan is not installed. Please choose option 2."
        fi
        ;;
      2)
        echo "resolved"
        return
        ;;
      *)
        print_msg "$RED" "  âœ— Invalid choice. Enter 1 or 2."
        ;;
    esac
  done
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Backup Functions
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

create_backup() {
  if [ ! -f "$BACKUP_CONF" ] && [ -f "$SYSTEMD_CONF" ]; then
    cp "$SYSTEMD_CONF" "$BACKUP_CONF"
    print_msg "$GREEN" "  âœ“ Backup created at $BACKUP_CONF"
  fi
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# NetPlan DNS Configuration
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

apply_dns_netplan() {
  local dns_primary=$1
  local dns_secondary=$2
  local dns_name=$3
  local fallback_dns=$4

  local iface=$(get_active_interface)

  if [ -z "$iface" ]; then
    print_msg "$RED" "  âœ— Could not detect active network interface."
    print_msg "$YELLOW" "  â–º Falling back to systemd-resolved..."
    apply_dns_resolved "$dns_primary" "$dns_secondary" "$dns_name" "$fallback_dns"
    return
  fi

  local iface_type=$(get_interface_type "$iface")

  # Wi-Fi: NetPlan requires access-points config, fall back to resolved
  if [ "$iface_type" = "wifis" ]; then
    print_msg "$YELLOW" "  â–º Wi-Fi detected â€” using systemd-resolved (NetPlan has limited Wi-Fi DNS support)."
    apply_dns_resolved "$dns_primary" "$dns_secondary" "$dns_name" "$fallback_dns"
    return
  fi

  print_msg "$CYAN" "  â–º Interface: $iface ($iface_type)"
  print_msg "$YELLOW" "  â–º Configuring DNS via NetPlan..."
  print_msg "$DIM" "    Primary: $dns_primary | Secondary: $dns_secondary"

  # Build DNS array
  local dns_array="\"$dns_primary\""
  if [ -n "$dns_secondary" ]; then
    dns_array="$dns_array, \"$dns_secondary\""
  fi
  if [ -n "$fallback_dns" ]; then
    for fb_dns in $fallback_dns; do
      dns_array="$dns_array, \"$fb_dns\""
    done
  fi

  # Create NetPlan configuration
  cat <<EOF > "$NETPLAN_FILE"
# DNS Manager v${VERSION} Configuration
# Generated: $TIMESTAMP
# DNS Provider: $dns_name
network:
  version: 2
  renderer: NetworkManager
  $iface_type:
    $iface:
      dhcp4: true
      nameservers:
        addresses: [$dns_array]
        search: []
      dhcp4-overrides:
        use-dns: false
EOF

  chmod 600 "$NETPLAN_FILE"

  # Remove legacy file if present
  rm -f /etc/netplan/01-dns-manager.yaml

  print_msg "$YELLOW" "  â–º Applying NetPlan configuration..."

  # Validate first
  if ! netplan generate >/dev/null 2>&1; then
    print_msg "$RED" "  âœ— NetPlan configuration is invalid. Reverting..."
    rm -f "$NETPLAN_FILE"
    print_msg "$YELLOW" "  â–º Falling back to systemd-resolved..."
    apply_dns_resolved "$dns_primary" "$dns_secondary" "$dns_name" "$fallback_dns"
    return
  fi

  # Apply
  if output=$(netplan apply 2>&1); then
    print_msg "$GREEN" "  âœ“ NetPlan configuration applied!"

    if systemctl restart systemd-resolved 2>/dev/null; then
      print_msg "$GREEN" "  âœ“ systemd-resolved restarted"
    fi

    if command -v nmcli &> /dev/null && nmcli general reload 2>/dev/null; then
      print_msg "$GREEN" "  âœ“ NetworkManager reloaded"
    fi

    # Ensure resolv.conf symlink
    if [ ! -L "$RESOLV_CONF" ] || [ "$(readlink "$RESOLV_CONF")" != "/run/systemd/resolve/stub-resolv.conf" ]; then
      ln -sf /run/systemd/resolve/stub-resolv.conf "$RESOLV_CONF"
    fi
  else
    print_msg "$RED" "  âœ— NetPlan apply failed: $output"
    rm -f "$NETPLAN_FILE"
    print_msg "$YELLOW" "  â–º Falling back to systemd-resolved..."
    apply_dns_resolved "$dns_primary" "$dns_secondary" "$dns_name" "$fallback_dns"
    return
  fi
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# systemd-resolved DNS Configuration
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

apply_dns_resolved() {
  local dns_primary=$1
  local dns_secondary=$2
  local dns_name=$3
  local fallback_dns=$4

  create_backup

  print_msg "$YELLOW" "  â–º Configuring DNS via systemd-resolved..."
  print_msg "$DIM" "    Primary: $dns_primary | Secondary: $dns_secondary"

  # Update DNS settings
  sed -i '/^DNS=/d' "$SYSTEMD_CONF"
  sed -i '/^#DNS=/d' "$SYSTEMD_CONF"
  sed -i "/^\[Resolve\]/a DNS=$dns_primary $dns_secondary" "$SYSTEMD_CONF"

  # Update FallbackDNS
  sed -i '/^FallbackDNS=/d' "$SYSTEMD_CONF"
  sed -i '/^#FallbackDNS=/d' "$SYSTEMD_CONF"
  sed -i "/^\[Resolve\]/a FallbackDNS=$fallback_dns" "$SYSTEMD_CONF"

  # Disable DNSStubListener
  sed -i 's/^#DNSStubListener=.*/DNSStubListener=no/' "$SYSTEMD_CONF"
  sed -i 's/^DNSStubListener=.*/DNSStubListener=no/' "$SYSTEMD_CONF"

  print_msg "$YELLOW" "  â–º Restarting systemd-resolved..."

  if systemctl restart systemd-resolved; then
    print_msg "$GREEN" "  âœ“ systemd-resolved restarted"
  else
    print_msg "$RED" "  âœ— Failed to restart systemd-resolved"
    return 1
  fi

  # Update resolv.conf symlink
  ln -sf /run/systemd/resolve/stub-resolv.conf "$RESOLV_CONF"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# DNS Connectivity Test
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

test_dns_connectivity() {
  local dns_ip=$1
  echo ""
  print_msg "$YELLOW" "  â–º Testing DNS connectivity..."

  if command -v nslookup &> /dev/null; then
    if nslookup google.com "$dns_ip" >/dev/null 2>&1; then
      print_msg "$GREEN" "  âœ“ DNS is working! (resolved google.com via $dns_ip)"
    else
      print_msg "$RED" "  âœ— DNS test failed. The server $dns_ip may not be reachable."
    fi
  elif command -v dig &> /dev/null; then
    if dig @"$dns_ip" google.com +short +time=3 >/dev/null 2>&1; then
      print_msg "$GREEN" "  âœ“ DNS is working! (resolved google.com via $dns_ip)"
    else
      print_msg "$RED" "  âœ— DNS test failed. The server $dns_ip may not be reachable."
    fi
  else
    print_msg "$DIM" "  â„¹ nslookup/dig not found â€” skipping connectivity test."
  fi
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Main Apply DNS Function (with Step 2: method selection)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

apply_dns() {
  local dns_primary=$1
  local dns_secondary=$2
  local dns_name=$3
  local fallback_dns=$4

  # Step 2: Choose method
  local method
  method=$(choose_apply_method)

  echo ""
  print_line
  print_msg "$CYAN" "  Applying ${BOLD}${dns_name}${NC}${CYAN} DNS via ${method}..."
  print_line
  echo ""

  if [ "$method" = "netplan" ]; then
    apply_dns_netplan "$dns_primary" "$dns_secondary" "$dns_name" "$fallback_dns"
  else
    apply_dns_resolved "$dns_primary" "$dns_secondary" "$dns_name" "$fallback_dns"
  fi

  # Show result
  echo ""
  print_line
  print_msg "$GREEN" "  âœ“ ${BOLD}${dns_name}${NC}${GREEN} DNS configured successfully via ${method}!"
  print_line

  # Test connectivity
  test_dns_connectivity "$dns_primary"

  # Show final status
  show_current_dns_status

  echo ""
  print_msg "$GREEN" "  âœ“ Done! Exiting DNS Manager."
  echo ""
  exit 0
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# DNS Provider Functions
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

add_shekan_pro() {
  apply_dns "178.22.122.101" "185.51.200.1" "Shekan Pro" "8.8.8.8 8.8.4.4"
}

add_shekan_free() {
  apply_dns "178.22.122.100" "185.51.200.2" "Shekan Free" "8.8.8.8 8.8.4.4"
}

add_arvan_dns() {
  apply_dns "217.218.127.127" "217.218.155.155" "Arvan Cloud" "1.1.1.1 1.0.0.1"
}

add_google_dns() {
  apply_dns "8.8.8.8" "8.8.4.4" "Google DNS" "1.1.1.1 1.0.0.1"
}

add_cloudflare_dns() {
  apply_dns "1.1.1.1" "1.0.0.1" "Cloudflare" "8.8.8.8 8.8.4.4"
}

add_quad9_dns() {
  apply_dns "9.9.9.9" "149.112.112.112" "Quad9 (Malware Block)" "8.8.8.8 1.1.1.1"
}

add_opendns() {
  apply_dns "208.67.222.222" "208.67.220.220" "OpenDNS" "8.8.8.8 1.1.1.1"
}

add_adguard_dns() {
  apply_dns "94.140.14.14" "94.140.15.15" "AdGuard (Ad Block)" "8.8.8.8 1.1.1.1"
}

add_level3_dns() {
  apply_dns "4.2.2.4" "4.2.2.1" "Level3 (4.2.2.4)" "8.8.8.8 1.1.1.1"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Custom DNS Function
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

add_custom_dns() {
  echo ""
  print_line
  echo -e "  ${BOLD}${WHITE}Enter Custom DNS Servers${NC}"
  print_line
  echo ""

  # Primary DNS (required)
  local dns_primary=""
  while true; do
    echo -n -e "  ${WHITE}Primary DNS IP: ${NC}"
    read -r dns_primary
    if validate_ipv4 "$dns_primary"; then
      break
    else
      print_msg "$RED" "  âœ— Invalid IP address. Format: x.x.x.x (e.g., 8.8.8.8)"
    fi
  done

  # Secondary DNS (optional)
  local dns_secondary=""
  echo -n -e "  ${WHITE}Secondary DNS IP ${DIM}(Enter to skip)${NC}: "
  read -r dns_secondary
  if [ -n "$dns_secondary" ]; then
    if ! validate_ipv4 "$dns_secondary"; then
      print_msg "$RED" "  âœ— Invalid IP. Skipping secondary DNS."
      dns_secondary=""
    fi
  fi

  echo ""
  print_msg "$CYAN" "  Primary:   $dns_primary"
  if [ -n "$dns_secondary" ]; then
    print_msg "$CYAN" "  Secondary: $dns_secondary"
  else
    print_msg "$DIM" "  Secondary: (none)"
  fi

  apply_dns "$dns_primary" "$dns_secondary" "Custom DNS" "8.8.8.8 1.1.1.1"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# System Management Submenu & Functions
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Helper: finish system management operation and exit
sysmgmt_done() {
  local msg="$1"
  echo ""
  print_line
  print_msg "$GREEN" "  âœ“ $msg"
  print_line
  show_current_dns_status
  echo ""
  print_msg "$GREEN" "  âœ“ Done! Exiting DNS Manager."
  echo ""
  exit 0
}

# â”€â”€ NetPlan Operations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

np_view() {
  echo ""
  print_line
  print_msg "$CYAN" "  NetPlan DNS Configuration"
  print_line

  if [ ! -f "$NETPLAN_FILE" ]; then
    print_msg "$DIM" "  â„¹ No DNS Manager NetPlan config found at $NETPLAN_FILE"
    echo ""
    return
  fi

  echo ""
  print_msg "$WHITE" "  File: ${DIM}$NETPLAN_FILE${NC}"
  echo ""
  echo -e "${DIM}"
  cat "$NETPLAN_FILE" 2>/dev/null | sed 's/^/    /'
  echo -e "${NC}"

  # Parse DNS addresses
  local np_dns=$(grep -A5 'addresses:' "$NETPLAN_FILE" 2>/dev/null | head -1 | sed 's/.*\[//;s/\].*//;s/"//g')
  if [ -n "$np_dns" ]; then
    print_msg "$GREEN" "  DNS addresses: $np_dns"
    local first_ip=$(echo "$np_dns" | cut -d',' -f1 | xargs)
    local provider=$(identify_dns_provider "$first_ip")
    if [ -n "$provider" ]; then
      print_msg "$DIM" "  Provider: $provider"
    fi
  fi
  echo ""
}

np_edit() {
  echo ""
  print_line
  print_msg "$CYAN" "  Edit NetPlan DNS Configuration"
  print_line

  if [ ! -f "$NETPLAN_FILE" ]; then
    print_msg "$DIM" "  â„¹ No NetPlan config found. Use a DNS option from the main menu first."
    echo ""
    return
  fi

  # Show current
  local np_dns=$(grep -A5 'addresses:' "$NETPLAN_FILE" 2>/dev/null | head -1 | sed 's/.*\[//;s/\].*//;s/"//g')
  print_msg "$DIM" "  Current DNS: $np_dns"
  echo ""

  # Prompt new primary
  local dns_primary=""
  while true; do
    echo -n -e "  ${WHITE}New Primary DNS IP: ${NC}"
    read -r dns_primary
    if validate_ipv4 "$dns_primary"; then
      break
    else
      print_msg "$RED" "  âœ— Invalid IP. Format: x.x.x.x"
    fi
  done

  # Prompt new secondary
  local dns_secondary=""
  echo -n -e "  ${WHITE}New Secondary DNS IP ${DIM}(Enter to skip)${NC}: "
  read -r dns_secondary
  if [ -n "$dns_secondary" ] && ! validate_ipv4 "$dns_secondary"; then
    print_msg "$RED" "  âœ— Invalid IP. Skipping secondary."
    dns_secondary=""
  fi

  local iface=$(get_active_interface)
  local iface_type=$(get_interface_type "$iface")

  # Build DNS array
  local dns_array="\"$dns_primary\""
  if [ -n "$dns_secondary" ]; then
    dns_array="$dns_array, \"$dns_secondary\""
  fi

  cat <<EOF > "$NETPLAN_FILE"
# DNS Manager v${VERSION} Configuration
# Generated: $TIMESTAMP
# DNS Provider: Custom (edited)
network:
  version: 2
  renderer: NetworkManager
  $iface_type:
    $iface:
      dhcp4: true
      nameservers:
        addresses: [$dns_array]
        search: []
      dhcp4-overrides:
        use-dns: false
EOF

  chmod 600 "$NETPLAN_FILE"

  print_msg "$YELLOW" "  â–º Validating configuration..."
  if ! netplan generate >/dev/null 2>&1; then
    print_msg "$RED" "  âœ— Configuration is invalid!"
    return
  fi

  if netplan apply 2>/dev/null; then
    systemctl restart systemd-resolved 2>/dev/null
    sysmgmt_done "NetPlan DNS updated to: $dns_primary ${dns_secondary:+, $dns_secondary}"
  else
    print_msg "$RED" "  âœ— Failed to apply NetPlan changes."
  fi
}

np_disable() {
  echo ""
  print_line
  print_msg "$YELLOW" "  Disable NetPlan DNS Configuration"
  print_line

  if [ ! -f "$NETPLAN_FILE" ]; then
    print_msg "$DIM" "  â„¹ No NetPlan config to disable."
    echo ""
    return
  fi

  print_msg "$YELLOW" "  â–º Disabling by renaming to .disabled..."
  mv "$NETPLAN_FILE" "${NETPLAN_FILE}.disabled"

  if [ $? -eq 0 ]; then
    print_msg "$GREEN" "  âœ“ Config moved to ${NETPLAN_FILE}.disabled"
  else
    print_msg "$RED" "  âœ— Failed to disable config."
    return
  fi

  print_msg "$YELLOW" "  â–º Applying NetPlan changes..."
  if netplan apply 2>/dev/null; then
    systemctl restart systemd-resolved 2>/dev/null
    ln -sf /run/systemd/resolve/resolv.conf "$RESOLV_CONF"
    sysmgmt_done "NetPlan DNS disabled. Config saved at ${NETPLAN_FILE}.disabled"
  else
    print_msg "$RED" "  âœ— Failed to apply. Restoring..."
    mv "${NETPLAN_FILE}.disabled" "$NETPLAN_FILE"
  fi
}

np_delete() {
  echo ""
  print_line
  print_msg "$RED" "  Delete NetPlan DNS Configuration"
  print_line

  if [ ! -f "$NETPLAN_FILE" ] && [ ! -f "${NETPLAN_FILE}.disabled" ]; then
    print_msg "$DIM" "  â„¹ No NetPlan config files to delete."
    echo ""
    return
  fi

  # Show what will be deleted
  if [ -f "$NETPLAN_FILE" ]; then
    print_msg "$DIM" "  Will delete: $NETPLAN_FILE"
  fi
  if [ -f "${NETPLAN_FILE}.disabled" ]; then
    print_msg "$DIM" "  Will delete: ${NETPLAN_FILE}.disabled"
  fi

  echo ""
  echo -n -e "  ${RED}Are you sure? ${WHITE}[y/N]: ${NC}"
  read -r confirm

  if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    print_msg "$DIM" "  Cancelled."
    echo ""
    return
  fi

  rm -f "$NETPLAN_FILE" "${NETPLAN_FILE}.disabled"
  print_msg "$GREEN" "  âœ“ NetPlan config files deleted."

  print_msg "$YELLOW" "  â–º Applying NetPlan changes..."
  if netplan apply 2>/dev/null; then
    systemctl restart systemd-resolved 2>/dev/null
    ln -sf /run/systemd/resolve/resolv.conf "$RESOLV_CONF"
    sysmgmt_done "NetPlan DNS configuration deleted permanently."
  else
    print_msg "$RED" "  âœ— Failed to apply changes."
  fi
}

np_rollback() {
  echo ""
  print_line
  print_msg "$YELLOW" "  Rollback NetPlan DNS Configuration"
  print_line

  # Check for disabled config first
  if [ -f "${NETPLAN_FILE}.disabled" ]; then
    print_msg "$YELLOW" "  â–º Found disabled config. Re-enabling..."
    mv "${NETPLAN_FILE}.disabled" "$NETPLAN_FILE"
    chmod 600 "$NETPLAN_FILE"

    if netplan generate >/dev/null 2>&1 && netplan apply 2>/dev/null; then
      systemctl restart systemd-resolved 2>/dev/null
      sysmgmt_done "NetPlan DNS re-enabled from disabled config."
    else
      print_msg "$RED" "  âœ— Restored config is invalid. Reverting..."
      mv "$NETPLAN_FILE" "${NETPLAN_FILE}.disabled"
      netplan apply 2>/dev/null
    fi
    return
  fi

  if [ -f "$NETPLAN_FILE" ]; then
    print_msg "$DIM" "  â„¹ NetPlan config is already active. Nothing to rollback."
  else
    print_msg "$DIM" "  â„¹ No NetPlan config or backup found to rollback."
  fi
  echo ""
}

# â”€â”€ resolv.conf / systemd-resolved Operations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

resolved_view() {
  echo ""
  print_line
  print_msg "$CYAN" "  systemd-resolved / resolv.conf Configuration"
  print_line

  # resolved.conf
  echo ""
  print_msg "$WHITE" "  â”€â”€ ${SYSTEMD_CONF} â”€â”€"
  if [ -f "$SYSTEMD_CONF" ]; then
    local dns_line=$(grep '^DNS=' "$SYSTEMD_CONF" 2>/dev/null)
    local fb_line=$(grep '^FallbackDNS=' "$SYSTEMD_CONF" 2>/dev/null)
    local stub_line=$(grep '^DNSStubListener=' "$SYSTEMD_CONF" 2>/dev/null)

    if [ -n "$dns_line" ]; then
      print_msg "$GREEN" "  $dns_line"
    else
      print_msg "$DIM" "  DNS= (not set, using defaults)"
    fi
    if [ -n "$fb_line" ]; then
      print_msg "$GREEN" "  $fb_line"
    fi
    if [ -n "$stub_line" ]; then
      print_msg "$DIM" "  $stub_line"
    fi
  else
    print_msg "$DIM" "  File not found."
  fi

  # resolv.conf
  echo ""
  print_msg "$WHITE" "  â”€â”€ ${RESOLV_CONF} â”€â”€"
  if [ -L "$RESOLV_CONF" ]; then
    print_msg "$DIM" "  Symlink â†’ $(readlink "$RESOLV_CONF")"
  fi
  local resolv_ns=$(grep '^nameserver' "$RESOLV_CONF" 2>/dev/null)
  if [ -n "$resolv_ns" ]; then
    while IFS= read -r line; do
      local ns_ip=$(echo "$line" | awk '{print $2}')
      local ns_name=$(identify_dns_provider "$ns_ip")
      if [ -n "$ns_name" ]; then
        print_msg "$GREEN" "  $line  ${DIM}($ns_name)"
      else
        print_msg "$GREEN" "  $line"
      fi
    done <<< "$resolv_ns"
  else
    print_msg "$DIM" "  No nameservers found."
  fi

  # Backup status
  echo ""
  if [ -f "$BACKUP_CONF" ]; then
    print_msg "$GREEN" "  âœ“ Backup exists: $BACKUP_CONF"
  else
    print_msg "$DIM" "  â„¹ No backup file found."
  fi

  # resolvectl
  if command -v resolvectl &> /dev/null; then
    echo ""
    print_msg "$WHITE" "  â”€â”€ resolvectl status â”€â”€"
    local dns_servers=$(resolvectl status 2>/dev/null | grep -A 10 "DNS Servers" | grep -E "^\s+[0-9]" | head -4)
    if [ -n "$dns_servers" ]; then
      while IFS= read -r line; do
        local srv_ip=$(echo "$line" | xargs)
        local srv_name=$(identify_dns_provider "$srv_ip")
        if [ -n "$srv_name" ]; then
          print_msg "$GREEN" "  $srv_ip  ${DIM}($srv_name)"
        else
          print_msg "$GREEN" "  $srv_ip"
        fi
      done <<< "$dns_servers"
    else
      print_msg "$DIM" "  No DNS servers reported."
    fi
  fi
  echo ""
}

resolved_edit() {
  echo ""
  print_line
  print_msg "$CYAN" "  Edit systemd-resolved DNS Configuration"
  print_line

  # Show current
  local current_dns=$(grep '^DNS=' "$SYSTEMD_CONF" 2>/dev/null | sed 's/DNS=//')
  if [ -n "$current_dns" ]; then
    print_msg "$DIM" "  Current DNS: $current_dns"
  else
    print_msg "$DIM" "  Current DNS: (system default)"
  fi
  echo ""

  # Prompt new primary
  local dns_primary=""
  while true; do
    echo -n -e "  ${WHITE}New Primary DNS IP: ${NC}"
    read -r dns_primary
    if validate_ipv4 "$dns_primary"; then
      break
    else
      print_msg "$RED" "  âœ— Invalid IP. Format: x.x.x.x"
    fi
  done

  # Prompt new secondary
  local dns_secondary=""
  echo -n -e "  ${WHITE}New Secondary DNS IP ${DIM}(Enter to skip)${NC}: "
  read -r dns_secondary
  if [ -n "$dns_secondary" ] && ! validate_ipv4 "$dns_secondary"; then
    print_msg "$RED" "  âœ— Invalid IP. Skipping secondary."
    dns_secondary=""
  fi

  create_backup

  sed -i '/^DNS=/d' "$SYSTEMD_CONF"
  sed -i '/^#DNS=/d' "$SYSTEMD_CONF"
  sed -i "/^\[Resolve\]/a DNS=$dns_primary $dns_secondary" "$SYSTEMD_CONF"

  # Disable DNSStubListener
  sed -i 's/^#DNSStubListener=.*/DNSStubListener=no/' "$SYSTEMD_CONF"
  sed -i 's/^DNSStubListener=.*/DNSStubListener=no/' "$SYSTEMD_CONF"

  if systemctl restart systemd-resolved 2>/dev/null; then
    ln -sf /run/systemd/resolve/stub-resolv.conf "$RESOLV_CONF"
    sysmgmt_done "resolved.conf DNS updated to: $dns_primary ${dns_secondary}"
  else
    print_msg "$RED" "  âœ— Failed to restart systemd-resolved."
  fi
}

resolved_disable() {
  echo ""
  print_line
  print_msg "$YELLOW" "  Disable Custom DNS in systemd-resolved"
  print_line

  local has_custom=false
  if grep -q '^DNS=' "$SYSTEMD_CONF" 2>/dev/null; then
    has_custom=true
  fi

  if [ "$has_custom" = false ]; then
    print_msg "$DIM" "  â„¹ No custom DNS entries found in resolved.conf."
    echo ""
    return
  fi

  create_backup

  print_msg "$YELLOW" "  â–º Removing DNS and FallbackDNS entries..."
  sed -i '/^DNS=/d' "$SYSTEMD_CONF"
  sed -i '/^FallbackDNS=/d' "$SYSTEMD_CONF"
  sed -i 's/^DNSStubListener=no/#DNSStubListener=yes/' "$SYSTEMD_CONF"

  if systemctl restart systemd-resolved 2>/dev/null; then
    ln -sf /run/systemd/resolve/resolv.conf "$RESOLV_CONF"
    sysmgmt_done "Custom DNS disabled in systemd-resolved. Using DHCP defaults."
  else
    print_msg "$RED" "  âœ— Failed to restart systemd-resolved."
  fi
}

resolved_delete() {
  echo ""
  print_line
  print_msg "$RED" "  Delete Custom DNS & Backup from systemd-resolved"
  print_line

  local has_entries=false
  if grep -q '^DNS=' "$SYSTEMD_CONF" 2>/dev/null; then
    has_entries=true
    print_msg "$DIM" "  Will remove: DNS entries from resolved.conf"
  fi
  if [ -f "$BACKUP_CONF" ]; then
    has_entries=true
    print_msg "$DIM" "  Will delete: $BACKUP_CONF"
  fi

  if [ "$has_entries" = false ]; then
    print_msg "$DIM" "  â„¹ Nothing to delete."
    echo ""
    return
  fi

  echo ""
  echo -n -e "  ${RED}Are you sure? ${WHITE}[y/N]: ${NC}"
  read -r confirm

  if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    print_msg "$DIM" "  Cancelled."
    echo ""
    return
  fi

  # Remove custom entries
  sed -i '/^DNS=/d' "$SYSTEMD_CONF"
  sed -i '/^FallbackDNS=/d' "$SYSTEMD_CONF"
  sed -i 's/^DNSStubListener=no/#DNSStubListener=yes/' "$SYSTEMD_CONF"

  # Delete backup
  rm -f "$BACKUP_CONF"
  print_msg "$GREEN" "  âœ“ Backup file deleted."

  if systemctl restart systemd-resolved 2>/dev/null; then
    ln -sf /run/systemd/resolve/resolv.conf "$RESOLV_CONF"
    sysmgmt_done "Custom DNS entries and backup deleted permanently."
  else
    print_msg "$RED" "  âœ— Failed to restart systemd-resolved."
  fi
}

resolved_rollback() {
  echo ""
  print_line
  print_msg "$YELLOW" "  Rollback systemd-resolved from Backup"
  print_line

  if [ ! -f "$BACKUP_CONF" ]; then
    print_msg "$DIM" "  â„¹ No backup file found at $BACKUP_CONF"
    print_msg "$DIM" "  Cannot rollback without a backup."
    echo ""
    return
  fi

  print_msg "$YELLOW" "  â–º Restoring from $BACKUP_CONF..."
  cp "$BACKUP_CONF" "$SYSTEMD_CONF"
  print_msg "$GREEN" "  âœ“ resolved.conf restored from backup."

  if systemctl restart systemd-resolved 2>/dev/null; then
    ln -sf /run/systemd/resolve/stub-resolv.conf "$RESOLV_CONF"
    sysmgmt_done "systemd-resolved rolled back to original backup."
  else
    print_msg "$RED" "  âœ— Failed to restart systemd-resolved."
  fi
}

# â”€â”€ Full System Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

reset_all() {
  echo ""
  print_line
  print_msg "$RED" "  Reset All DNS Manager Configurations"
  print_line
  echo ""

  print_msg "$YELLOW" "  This will:"
  print_msg "$DIM" "    â€¢ Delete NetPlan DNS config (+ disabled copy)"
  print_msg "$DIM" "    â€¢ Remove custom DNS from systemd-resolved"
  print_msg "$DIM" "    â€¢ Restore resolv.conf symlink to default"
  print_msg "$DIM" "    â€¢ Delete backup file"
  echo ""
  echo -n -e "  ${RED}Are you sure? ${WHITE}[y/N]: ${NC}"
  read -r confirm

  if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    print_msg "$DIM" "  Cancelled."
    echo ""
    return
  fi

  echo ""
  local changes=0

  # NetPlan
  if [ -f "$NETPLAN_FILE" ] || [ -f "${NETPLAN_FILE}.disabled" ]; then
    rm -f "$NETPLAN_FILE" "${NETPLAN_FILE}.disabled"
    print_msg "$GREEN" "  âœ“ NetPlan config files removed."
    if check_netplan_installed; then
      netplan apply 2>/dev/null
    fi
    changes=$((changes + 1))
  fi

  # systemd-resolved
  if [ -f "$SYSTEMD_CONF" ]; then
    sed -i '/^DNS=/d' "$SYSTEMD_CONF"
    sed -i '/^FallbackDNS=/d' "$SYSTEMD_CONF"
    sed -i 's/^DNSStubListener=no/#DNSStubListener=yes/' "$SYSTEMD_CONF"
    print_msg "$GREEN" "  âœ“ systemd-resolved custom entries removed."
    changes=$((changes + 1))
  fi

  # Backup
  if [ -f "$BACKUP_CONF" ]; then
    rm -f "$BACKUP_CONF"
    print_msg "$GREEN" "  âœ“ Backup file deleted."
    changes=$((changes + 1))
  fi

  # Symlink
  ln -sf /run/systemd/resolve/resolv.conf "$RESOLV_CONF"
  print_msg "$GREEN" "  âœ“ resolv.conf symlink restored to default."

  # Restart
  systemctl restart systemd-resolved 2>/dev/null

  if [ $changes -gt 0 ]; then
    sysmgmt_done "Full DNS reset complete. All DNS Manager configs removed."
  else
    print_msg "$DIM" "  â„¹ System was already clean. No changes needed."
    show_current_dns_status
    echo ""
    exit 0
  fi
}

# â”€â”€ System Management Submenu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

show_sysmgmt_menu() {
  clear
  echo ""
  echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
  echo -e "${BLUE}â•‘${NC}${BOLD}${WHITE}              âš™  System Management                          ${NC}${BLUE}â•‘${NC}"
  echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

  echo ""

  # NetPlan status indicator
  local np_status="${DIM}not found${NC}"
  if [ -f "$NETPLAN_FILE" ]; then
    np_status="${GREEN}â— active${NC}"
  elif [ -f "${NETPLAN_FILE}.disabled" ]; then
    np_status="${YELLOW}â— disabled${NC}"
  fi

  # Resolved status indicator
  local res_status="${DIM}default${NC}"
  if grep -q '^DNS=' "$SYSTEMD_CONF" 2>/dev/null; then
    res_status="${GREEN}â— custom DNS set${NC}"
  fi

  echo -e " ${GREEN}â”€â”€ NetPlan${NC} ${DIM}($NETPLAN_FILE)${NC} [$np_status]"
  echo -e "  ${WHITE} 1)${NC} View     ${DIM}â€” Show current NetPlan DNS config${NC}"
  echo -e "  ${WHITE} 2)${NC} Edit     ${DIM}â€” Modify DNS addresses in NetPlan${NC}"
  echo -e "  ${WHITE} 3)${NC} Disable  ${DIM}â€” Suspend config without deleting${NC}"
  echo -e "  ${WHITE} 4)${NC} Delete   ${DIM}â€” Remove NetPlan config permanently${NC}"
  echo -e "  ${WHITE} 5)${NC} Rollback ${DIM}â€” Re-enable disabled config${NC}"

  echo ""
  echo -e " ${YELLOW}â”€â”€ resolv.conf / systemd-resolved${NC} [$res_status]"
  echo -e "  ${WHITE} 6)${NC} View     ${DIM}â€” Show resolved.conf & resolv.conf${NC}"
  echo -e "  ${WHITE} 7)${NC} Edit     ${DIM}â€” Modify DNS in resolved.conf${NC}"
  echo -e "  ${WHITE} 8)${NC} Disable  ${DIM}â€” Remove custom DNS, use DHCP defaults${NC}"
  echo -e "  ${WHITE} 9)${NC} Delete   ${DIM}â€” Remove custom DNS entries & backup${NC}"
  echo -e "  ${WHITE}10)${NC} Rollback ${DIM}â€” Restore resolved.conf from backup${NC}"

  echo ""
  echo -e " ${RED}â”€â”€ Full System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
  echo -e "  ${WHITE}11)${NC} ${RED}Reset All${NC} ${DIM}â€” Remove ALL DNS Manager configurations${NC}"

  echo ""
  echo -e "  ${WHITE} 0)${NC} â† Back to main menu"
  echo ""
}

system_management() {
  while true; do
    show_sysmgmt_menu
    echo -n -e "  ${WHITE}Choose an option: ${NC}"
    read -r sm_choice

    case "$sm_choice" in
      1)  np_view ;;
      2)  np_edit ;;
      3)  np_disable ;;
      4)  np_delete ;;
      5)  np_rollback ;;
      6)  resolved_view ;;
      7)  resolved_edit ;;
      8)  resolved_disable ;;
      9)  resolved_delete ;;
      10) resolved_rollback ;;
      11) reset_all ;;
      0)  return ;;
      *)
        print_msg "$RED" "  âœ— Invalid option. Enter 0-11."
        sleep 1
        ;;
    esac

    # If we're still here (view operations), pause before returning to submenu
    echo -e "${DIM}  Press Enter to continue...${NC}"
    read -r
  done
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Main
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

main() {
  while true; do
    show_menu
    echo -n -e "  ${WHITE}Choose an option: ${NC}"
    read -r choice

    case $choice in
      1) add_shekan_pro ;;
      2) add_shekan_free ;;
      3) add_arvan_dns ;;
      4) add_google_dns ;;
      5) add_cloudflare_dns ;;
      6) add_quad9_dns ;;
      7) add_opendns ;;
      8) add_adguard_dns ;;
      9) add_level3_dns ;;
      [Cc]) add_custom_dns ;;
      [Ss]) system_management ;;
      0)
        echo ""
        print_msg "$GREEN" "  âœ“ Exiting DNS Manager. Goodbye!"
        echo ""
        exit 0
        ;;
      *)
        print_msg "$RED" "  âœ— Invalid option. Please try again."
        sleep 1
        ;;
    esac
  done
}

# Run
main
